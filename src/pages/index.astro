---
import BaseLayout from '../layouts/BaseLayout.astro';
import VenueCard from '../components/VenueCard.astro';
import IntroBlock from '../components/IntroBlock.astro';
import venues from '../data/venues.json';
import { venueDetailPath } from '../lib/slug-utils';

const siteUrl = Astro.site?.toString().replace(/\/$/, '') ?? "https://informationa.pages.dev";

const itemListElements = venues.map((v, i) => ({
  "@type": "ListItem",
  "position": i + 1,
  "name": v.name,
  "url": `${siteUrl}${venueDetailPath(v)}`
}));

const jsonLd = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "name": "클럽·나이트·라운지 가이드",
      "url": `${siteUrl}/`,
      "inLanguage": "ko",
      "description": "괜찮은 사람 만나려면 장소 선택이 전부다 — 클럽 헌팅, 나이트 부킹, 라운지 만남 현장 비교",
      "potentialAction": {
        "@type": "SearchAction",
        "target": `${siteUrl}/?q={search_term_string}`,
        "query-input": "required name=search_term_string"
      }
    },
    {
      "@type": "Organization",
      "name": "클럽·나이트·라운지 가이드",
      "url": `${siteUrl}/`,
      "logo": `${siteUrl}/images/og-thumb.jpg`
    },
    {
      "@type": "ItemList",
      "name": "클럽·나이트·라운지 전체 리스트",
      "description": "헌팅·부킹·만남 성공률 높은 곳만 추려 현장 비교한 전국 가이드",
      "numberOfItems": venues.length,
      "itemListElement": itemListElements
    }
  ]
};

const regions = [...new Set(venues.map(v => v.region))];
const categories = [...new Set(venues.map(v => v.category))];
---
<BaseLayout
  title="클럽 헌팅·나이트 부킹·라운지 만남 — 장소 선택이 결과를 바꾼다"
  description={`괜찮은 사람 만나려면 어디로 가야 할까? 강남·홍대·이태원 클럽부터 전국 나이트까지 ${venues.length}곳 직접 가봤다. 이성 비율·분위기·타이밍 — 현장 경험 기반 솔직 비교.`}
  jsonLd={jsonLd}
>
  <!-- HERO + SEARCH -->
  <section class="hero" aria-label="메인 검색">
    <div class="container">
      <div class="hero__inner">
        <h1>클럽·나이트·라운지<br>괜찮은 사람 만나려면 여기부터</h1>
        <p class="hero__desc">전국 {venues.length}곳 직접 확인 · 이성 비율·분위기·헌팅 타이밍 · 현장 경험 기반 비교</p>
        <div class="search-box" role="search" aria-label="장소 검색">
          <input type="search" class="search-box__input" id="search-input" placeholder="장소 이름 또는 지역 검색" autocomplete="off" aria-label="장소 검색">
          <button class="search-box__btn" type="button" aria-label="찾기">⌕</button>
          <div class="search-results" id="search-results" role="listbox"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- INTRO BLOCK -->
  <IntroBlock
    hookHeadline="장소 잘못 고르면, 오늘 밤 아무도 못 만난다"
    bullets={[
      "클럽 헌팅: 강남은 자정 이후 이성 비율이 역전된다 — 타이밍이 성공률을 결정한다",
      "나이트 부킹: 테이블 위치가 부킹 횟수의 80%를 좌우한다 — 자리 선택법이 핵심",
      "라운지 만남: 예약석 배치로 옆 테이블과의 거리가 달라진다 — 좌석 구조 파악 필수"
    ]}
    declaration={`이 페이지는 클럽·나이트·라운지 ${venues.length}곳을 직접 돌아보고, 만남이 잘 이루어지는 곳만 정리했다. 끝까지 보면 오늘 밤 갈 곳이 정해진다.`}
    storyVisible={'<p>금요일 밤 11시, 강남역 사거리. 사람들이 지하 클럽으로 사라진다. 같은 강남이라도 어디를 가느냐에 따라 오늘 밤 누군가를 만나느냐, 혼자 춤만 추다 끝나느냐가 갈린다. 홍대 골목도 마찬가지 — 헌팅이 활발한 클럽과 음악만 듣는 클럽은 입구부터 분위기가 다르다.</p><p>나이트 부킹은 타이밍과 자리가 전부고, 라운지 만남은 분위기와 좌석 배치가 결정한다. 장소 선택이 곧 결과다.</p>'}
    storyHidden={'<p>수유·상봉·신림 같은 로컬 나이트는 부킹 문화가 살아있는 곳이다. 강남 클럽의 헌팅과는 완전히 다른 방식으로 만남이 이루어진다. 웨이터가 직접 테이블을 연결해주는 전통 부킹 시스템이 아직 작동하고, 인천 아라비안나이트처럼 3개 층에서 각각 다른 분위기의 만남이 가능한 곳도 있다.</p><p>이 가이드는 클럽 헌팅, 나이트 부킹, 라운지 만남까지 전국을 한눈에 비교하도록 만들었다. 카드의 "상세 가이드 보기"를 누르면 이성 비율·분위기·좌석 배치·FAQ까지 확인 가능하다.</p>'}
    ctas={[
      { label: "나이트 전체 보기", href: "/nights/" },
      { label: "클럽 전체 보기", href: "/clubs/" },
      { label: "라운지 전체 보기", href: "/lounges/" }
    ]}
  />

  <!-- QUICK FILTERS -->
  <section class="section section--filters" aria-label="빠른 필터">
    <div class="container">
      <div class="filter-group">
        <h3 class="filter-group__label">지역</h3>
        <div class="filter-bar" data-filter="region">
          <button class="filter-pill active" data-value="all">전체</button>
          {regions.map(r => <button class="filter-pill" data-value={r}>{r}</button>)}
        </div>
      </div>
      <div class="filter-group">
        <h3 class="filter-group__label">카테고리</h3>
        <div class="filter-bar" data-filter="category">
          <button class="filter-pill active" data-value="all">전체</button>
          {categories.map(c => <button class="filter-pill" data-value={c}>{c}</button>)}
        </div>
      </div>
    </div>
  </section>

  <main id="main-content">
    <!-- VENUE GRID -->
    <section class="section" id="recommend">
      <div class="container">
        <div class="section__header" data-reveal>
          <span class="section__eyebrow">All Venues</span>
          <h2>전체 {venues.length}곳</h2>
          <p>전국 클럽·나이트·라운지를 한눈에.</p>
        </div>
        <div class="venue-grid" id="venue-grid">
          {venues.map(v => {
            const detailUrl = venueDetailPath(v);
            return (
              <VenueCard
                name={v.name}
                category={v.category}
                region={v.region}
                thumbnail={v.thumbnail}
                image_alt={v.image_alt}
                badge={v.badge}
                card_hook={v.card_hook}
                card_value={v.card_value}
                card_tags={v.card_tags}
                detail_page={detailUrl}
                map_url={v.map_url}
              />
            );
          })}
        </div>
        <p class="no-results" id="no-results" style="display:none;text-align:center;padding:var(--sp-2xl) 0;color:var(--c-muted);">
          조건에 맞는 장소가 없습니다. 필터를 변경해 보세요.
        </p>
      </div>
    </section>

    <!-- UPDATES -->
    <section class="section" id="updates">
      <div class="container">
        <div class="section__header" data-reveal>
          <span class="section__eyebrow">Updates</span>
          <h2>업데이트 로그</h2>
        </div>
        <div class="update-list">
          <div class="update-card"><span class="update-card__date">2026.02.20</span><span class="update-card__text">전국 57곳 확장, 동적 상세 페이지 도입</span></div>
          <div class="update-card"><span class="update-card__date">2026.02.20</span><span class="update-card__text">Astro SSG 마이그레이션, 카드 가로형 레이아웃 적용</span></div>
          <div class="update-card"><span class="update-card__date">2026.02.18</span><span class="update-card__text">FAQ·갤러리·신뢰 블록 전 페이지 추가</span></div>
          <div class="update-card"><span class="update-card__date">2026.02.15</span><span class="update-card__text">네이버 지도 연결, 관련 페이지 내부 링크 확장</span></div>
          <div class="update-card"><span class="update-card__date">2026.02.02</span><span class="update-card__text">디렉토리 초판 작성</span></div>
        </div>
      </div>
    </section>

    <!-- POLICY -->
    <section class="section" id="policy">
      <div class="container">
        <div class="section__header" data-reveal>
          <span class="section__eyebrow">Policy</span>
          <h2>편집 정책</h2>
        </div>
        <div class="policy-grid">
          <div class="policy-grid__item"><h3>비상업 원칙</h3><p>광고비·협찬 없이 작성합니다. 어떤 업소와도 상업적 관계가 없습니다.</p></div>
          <div class="policy-grid__item"><h3>현장 기반</h3><p>정보는 2026년 1분기 현장 방문을 참고로 하며, 변경 사항은 즉시 반영합니다.</p></div>
          <div class="policy-grid__item"><h3>정정 요청</h3><p>틀린 정보를 발견하면 각 페이지 하단 '정정 요청' 버튼을 이용해 주세요.</p></div>
          <div class="policy-grid__item"><h3>개인정보</h3><p>방문자 개인정보를 수집하지 않습니다. 쿠키는 분석 목적으로만 사용됩니다.</p></div>
        </div>
      </div>
    </section>
  </main>

  <script type="application/json" id="venue-data" set:html={JSON.stringify(venues.map(v => ({
    name: v.name, region: v.region, district: v.district, category: v.category,
    thumbnail: v.thumbnail, keywords: v.keywords, tags: v.tags, card_tags: v.card_tags,
    _link: venueDetailPath(v)
  })))} />
  <script is:inline>
    // ── Search Index ──
    var venueData = JSON.parse(document.getElementById('venue-data').textContent || '[]');
    var searchInput = document.getElementById('search-input');
    var searchResults = document.getElementById('search-results');
    var activeIdx = -1;

    // Normalize: trim, lowercase, remove all whitespace for fuzzy matching
    function norm(s) { return (s || '').trim().toLowerCase().replace(/\s+/g, ''); }

    // Build search index: each venue gets a flat array of searchable tokens
    var searchIndex = venueData.map(function(v) {
      var tokens = [v.name, v.region, v.district, v.category];
      if (v.keywords) tokens = tokens.concat(v.keywords);
      if (v.tags) tokens = tokens.concat(v.tags);
      if (v.card_tags) tokens = tokens.concat(v.card_tags);
      return {
        venue: v,
        raw: tokens.join(' ').toLowerCase(),
        norm: tokens.map(norm).join(' ')
      };
    });

    function searchVenues(query) {
      var q = query.trim().toLowerCase();
      var qNorm = norm(query);
      if (!q) return [];
      var exact = [], partial = [];
      searchIndex.forEach(function(entry) {
        var v = entry.venue;
        var nameLower = v.name.toLowerCase();
        var nameNorm = norm(v.name);
        // Exact name match (highest priority)
        if (nameLower === q || nameNorm === qNorm) {
          exact.push(v);
        // Name contains query
        } else if (nameLower.indexOf(q) !== -1 || nameNorm.indexOf(qNorm) !== -1) {
          partial.unshift(v);
        // Any field contains query (keywords, tags, region, etc.)
        } else if (entry.raw.indexOf(q) !== -1 || entry.norm.indexOf(qNorm) !== -1) {
          partial.push(v);
        }
      });
      return exact.concat(partial);
    }

    function getLink(v) {
      return v._link || v.detail_page || ('/' + v.cat_slug + '/' + v.region_slug + '/' + v.district_slug + '/' + v.slug + '/');
    }

    function renderResults(matches) {
      if (!matches.length) { searchResults.classList.remove('is-open'); return; }
      searchResults.innerHTML = matches.slice(0, 8).map(function(v, i) {
        return '<a class="search-item' + (i === activeIdx ? ' is-active' : '') + '" href="' + getLink(v) + '" target="_blank" rel="noopener noreferrer" role="option">' +
          '<div class="search-item__thumb"><img src="' + v.thumbnail + '" alt="' + v.name + '" width="40" height="40"></div>' +
          '<div class="search-item__info"><div class="search-item__name">' + v.name + '</div>' +
          '<div class="search-item__meta">' + v.region + ' ' + v.district + ' · ' + v.category + '</div></div>' +
          '<span class="search-item__cta">상세보기 →</span></a>';
      }).join('');
      searchResults.classList.add('is-open');
    }

    if (searchInput) {
      searchInput.addEventListener('input', function() {
        var q = searchInput.value.trim();
        if (!q) { searchResults.classList.remove('is-open'); return; }
        activeIdx = -1;
        renderResults(searchVenues(q));
      });

      searchInput.addEventListener('keydown', function(e) {
        var items = searchResults.querySelectorAll('.search-item');
        if (!items.length) return;
        if (e.key === 'ArrowDown') { e.preventDefault(); activeIdx = Math.min(activeIdx + 1, items.length - 1); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); activeIdx = Math.max(activeIdx - 1, 0); }
        else if (e.key === 'Enter' && activeIdx >= 0) { e.preventDefault(); items[activeIdx].click(); }
        else if (e.key === 'Escape') { searchResults.classList.remove('is-open'); return; }
        items.forEach(function(el, i) { el.classList.toggle('is-active', i === activeIdx); });
      });
    }

    document.addEventListener('click', function(e) {
      if (!e.target.closest('.search-box')) searchResults.classList.remove('is-open');
    });

    // Quick Filters
    var cards = document.querySelectorAll('.venue-card');
    var noResults = document.getElementById('no-results');
    var regionFilter = 'all', catFilter = 'all';

    function applyFilters() {
      var visible = 0;
      cards.forEach(function(card) {
        var r = card.querySelector('.venue-card__region') ? card.querySelector('.venue-card__region').textContent : '';
        var c = card.querySelector('.venue-card__type') ? card.querySelector('.venue-card__type').textContent : '';
        var show = (regionFilter === 'all' || r === regionFilter) && (catFilter === 'all' || c === catFilter);
        card.style.display = show ? '' : 'none';
        if (show) visible++;
      });
      if (noResults) noResults.style.display = visible ? 'none' : '';
    }

    document.querySelectorAll('.filter-bar').forEach(function(bar) {
      bar.addEventListener('click', function(e) {
        var pill = e.target.closest('.filter-pill');
        if (!pill) return;
        var filterType = bar.dataset.filter;
        bar.querySelectorAll('.filter-pill').forEach(function(p) { p.classList.remove('active'); });
        pill.classList.add('active');
        if (filterType === 'region') regionFilter = pill.dataset.value || 'all';
        else catFilter = pill.dataset.value || 'all';
        applyFilters();
      });
    });
  </script>
</BaseLayout>
