---
import BaseLayout from '../layouts/BaseLayout.astro';
import VenueCard from '../components/VenueCard.astro';
import IntroBlock from '../components/IntroBlock.astro';
import venues from '../data/venues.json';
import { venueDetailPath } from '../lib/slug-utils';

const siteUrl = Astro.site?.toString().replace(/\/$/, '') ?? "https://informationa.pages.dev";

const itemListElements = venues.map((v, i) => ({
  "@type": "ListItem",
  "position": i + 1,
  "name": v.name,
  "url": `${siteUrl}${venueDetailPath(v)}`
}));

const jsonLd = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "name": "전국 클럽·나이트·라운지 디렉토리",
      "url": `${siteUrl}/`,
      "inLanguage": "ko",
      "description": "서울 강남 클럽, 홍대 클럽, 이태원 클럽, 나이트클럽, 라운지바를 현장 확인 토대로 비교하는 2026 나이트라이프 가이드",
      "potentialAction": {
        "@type": "SearchAction",
        "target": `${siteUrl}/?q={search_term_string}`,
        "query-input": "required name=search_term_string"
      }
    },
    {
      "@type": "Organization",
      "name": "전국 클럽·나이트·라운지 디렉토리",
      "url": `${siteUrl}/`,
      "logo": `${siteUrl}/images/og-thumb.jpg`,
      "sameAs": []
    },
    {
      "@type": "ItemList",
      "name": "전국 클럽·나이트·라운지 추천 리스트 2026",
      "description": "서울, 수도권, 지방 주요 클럽·나이트·라운지를 현장 확인 후 정리한 나이트라이프 디렉토리",
      "numberOfItems": venues.length,
      "itemListElement": itemListElements
    }
  ]
};

const regions = [...new Set(venues.map(v => v.region))];
const categories = [...new Set(venues.map(v => v.category))];
---
<BaseLayout
  title="클럽·나이트·라운지 추천 — 서울 강남 홍대 이태원 전국 나이트라이프 가이드 2026"
  description="서울 클럽 추천, 강남 나이트, 홍대 클럽, 이태원 라운지, 나이트클럽 순위부터 부산·대구·대전·인천·수원·제주까지 전국 주요 클럽·나이트·라운지 현장 확인 비교 가이드. 2026년 최신 업데이트."
  jsonLd={jsonLd}
>
  <!-- HERO + SEARCH -->
  <section class="hero" aria-label="메인 검색">
    <div class="container">
      <div class="hero__inner">
        <h1>전국 클럽·나이트·라운지 추천<br>2026 나이트라이프 가이드</h1>
        <p class="hero__desc">서울 강남·홍대·이태원부터 부산·대구·대전·인천까지 — {venues.length}곳 현장 확인 · 지도 연결 · 2026 최신 업데이트</p>
        <div class="search-box" role="search" aria-label="장소 검색">
          <input type="search" class="search-box__input" id="search-input" placeholder="클럽·나이트·라운지 이름 또는 지역 검색" autocomplete="off" aria-label="장소 검색">
          <button class="search-box__btn" type="button" aria-label="검색">⌕</button>
          <div class="search-results" id="search-results" role="listbox"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- INTRO BLOCK -->
  <IntroBlock
    hookHeadline="서울 나이트라이프, 검색만으로 판단하면 절반은 운이다"
    bullets={[
      "피크타임: 금·토 23시~01시 — 입장 대기 30분 이상인 클럽이 절반을 넘는다",
      "교통: 강남·홍대는 지하철 막차(23:40) 이후 택시 할증 구간, 호출 앱 필수",
      "드레스코드: 강남·청담은 스마트캐주얼 기본, 홍대·이태원은 운동화 OK"
    ]}
    declaration={`이 페이지는 ${venues.length}개 장소를 현장 확인 토대로 정리했다. 끝까지 보면 오늘 밤 선택지가 좁혀진다.`}
    storyVisible={'<p>금요일 밤 11시, 강남역 사거리. 택시에서 내린 사람들이 지하로 사라진다. 어디로 가는지 모르면 줄만 서다 새벽을 맞는다. 홍대 골목은 또 다르다 — 간판 없는 지하 계단 앞에서 귓속말처럼 번호를 불러야 문이 열리는 곳도 있다.</p><p>이태원 뒷골목 3층 테크노 성지부터, 청담 새벽 4시에 문을 여는 애프터클럽까지. 서울 나이트라이프는 "아는 만큼 보인다"는 말이 가장 잘 맞는 분야다.</p>'}
    storyHidden={'<p>수유·상봉·신림 같은 로컬 나이트를 빼놓으면 서울 야간 문화의 절반을 놓치는 셈이다. 강남 클럽이 트렌드를 이끌지만, 30~50대가 주축인 로컬 나이트에서는 라이브 무대와 가성비 좌석 배치가 오히려 매력이다. 인천 아라비안나이트처럼 3개 층 규모에 발렛 주차까지 갖춘 곳도 있고, 파주 스카이돔처럼 돔형 천장이 음향을 완전히 바꾸는 구조도 있다.</p><p>이 디렉토리는 서울·수도권·지방 주요 나이트라이프를 한눈에 비교하도록 만들었다. 각 카드의 "상세 가이드 보기"를 누르면 교통·피크타임·좌석 배치·FAQ까지 확인할 수 있다.</p>'}
    ctas={[
      { label: "나이트 전체 보기", href: "/nights/" },
      { label: "클럽 전체 보기", href: "/clubs/" },
      { label: "라운지 전체 보기", href: "/lounges/" }
    ]}
  />

  <!-- QUICK FILTERS -->
  <section class="section section--filters" aria-label="빠른 필터">
    <div class="container">
      <div class="filter-group">
        <h3 class="filter-group__label">지역</h3>
        <div class="filter-bar" data-filter="region">
          <button class="filter-pill active" data-value="all">전체</button>
          {regions.map(r => <button class="filter-pill" data-value={r}>{r}</button>)}
        </div>
      </div>
      <div class="filter-group">
        <h3 class="filter-group__label">카테고리</h3>
        <div class="filter-bar" data-filter="category">
          <button class="filter-pill active" data-value="all">전체</button>
          {categories.map(c => <button class="filter-pill" data-value={c}>{c}</button>)}
        </div>
      </div>
    </div>
  </section>

  <main id="main-content">
    <!-- VENUE GRID -->
    <section class="section" id="recommend">
      <div class="container">
        <div class="section__header" data-reveal>
          <span class="section__eyebrow">All Venues</span>
          <h2>전체 {venues.length}곳</h2>
          <p>서울·수도권·지방 주요 클럽·나이트·라운지를 한눈에.</p>
        </div>
        <div class="venue-grid" id="venue-grid">
          {venues.map(v => {
            const detailUrl = venueDetailPath(v);
            return (
              <VenueCard
                name={v.name}
                category={v.category}
                region={v.region}
                thumbnail={v.thumbnail}
                image_alt={v.image_alt}
                badge={v.badge}
                card_hook={v.card_hook}
                card_value={v.card_value}
                card_tags={v.card_tags}
                detail_page={detailUrl}
                map_url={v.map_url}
              />
            );
          })}
        </div>
        <p class="no-results" id="no-results" style="display:none;text-align:center;padding:var(--sp-2xl) 0;color:var(--c-muted);">
          조건에 맞는 장소가 없습니다. 필터를 변경해 보세요.
        </p>
      </div>
    </section>

    <!-- UPDATES -->
    <section class="section" id="updates">
      <div class="container">
        <div class="section__header" data-reveal>
          <span class="section__eyebrow">Updates</span>
          <h2>업데이트 로그</h2>
        </div>
        <div class="update-list">
          <div class="update-card"><span class="update-card__date">2026.02.20</span><span class="update-card__text">전국 57곳 확장, 동적 상세 페이지 도입</span></div>
          <div class="update-card"><span class="update-card__date">2026.02.20</span><span class="update-card__text">Astro SSG 마이그레이션, 카드 가로형 레이아웃 적용</span></div>
          <div class="update-card"><span class="update-card__date">2026.02.18</span><span class="update-card__text">FAQ·갤러리·신뢰 블록 전 페이지 추가</span></div>
          <div class="update-card"><span class="update-card__date">2026.02.15</span><span class="update-card__text">네이버 지도 연결, 관련 페이지 내부 링크 확장</span></div>
          <div class="update-card"><span class="update-card__date">2026.02.02</span><span class="update-card__text">디렉토리 초판 작성</span></div>
        </div>
      </div>
    </section>

    <!-- POLICY -->
    <section class="section" id="policy">
      <div class="container">
        <div class="section__header" data-reveal>
          <span class="section__eyebrow">Policy</span>
          <h2>편집 정책</h2>
        </div>
        <div class="policy-grid">
          <div class="policy-grid__item"><h3>비상업 원칙</h3><p>광고비·협찬 없이 작성합니다. 어떤 업소와도 상업적 관계가 없습니다.</p></div>
          <div class="policy-grid__item"><h3>현장 확인</h3><p>정보는 2026년 1분기 현장 확인을 참고로 하며, 변경 사항은 즉시 반영합니다.</p></div>
          <div class="policy-grid__item"><h3>정정 요청</h3><p>틀린 정보를 발견하면 각 페이지 하단 '정정 요청' 버튼을 이용해 주세요.</p></div>
          <div class="policy-grid__item"><h3>개인정보</h3><p>방문자 개인정보를 수집하지 않습니다. 쿠키는 분석 목적으로만 사용됩니다.</p></div>
        </div>
      </div>
    </section>
  </main>

  <script type="application/json" id="venue-data" set:html={JSON.stringify(venues.map(v => ({
    name: v.name, region: v.region, district: v.district, category: v.category,
    thumbnail: v.thumbnail, keywords: v.keywords, tags: v.tags, card_tags: v.card_tags,
    _link: venueDetailPath(v)
  })))} />
  <script is:inline>
    // ── Search Index ──
    var venueData = JSON.parse(document.getElementById('venue-data').textContent || '[]');
    var searchInput = document.getElementById('search-input');
    var searchResults = document.getElementById('search-results');
    var activeIdx = -1;

    // Normalize: trim, lowercase, remove all whitespace for fuzzy matching
    function norm(s) { return (s || '').trim().toLowerCase().replace(/\s+/g, ''); }

    // Build search index: each venue gets a flat array of searchable tokens
    var searchIndex = venueData.map(function(v) {
      var tokens = [v.name, v.region, v.district, v.category];
      if (v.keywords) tokens = tokens.concat(v.keywords);
      if (v.tags) tokens = tokens.concat(v.tags);
      if (v.card_tags) tokens = tokens.concat(v.card_tags);
      return {
        venue: v,
        raw: tokens.join(' ').toLowerCase(),
        norm: tokens.map(norm).join(' ')
      };
    });

    function searchVenues(query) {
      var q = query.trim().toLowerCase();
      var qNorm = norm(query);
      if (!q) return [];
      var exact = [], partial = [];
      searchIndex.forEach(function(entry) {
        var v = entry.venue;
        var nameLower = v.name.toLowerCase();
        var nameNorm = norm(v.name);
        // Exact name match (highest priority)
        if (nameLower === q || nameNorm === qNorm) {
          exact.push(v);
        // Name contains query
        } else if (nameLower.indexOf(q) !== -1 || nameNorm.indexOf(qNorm) !== -1) {
          partial.unshift(v);
        // Any field contains query (keywords, tags, region, etc.)
        } else if (entry.raw.indexOf(q) !== -1 || entry.norm.indexOf(qNorm) !== -1) {
          partial.push(v);
        }
      });
      return exact.concat(partial);
    }

    function getLink(v) {
      return v._link || v.detail_page || ('/' + v.cat_slug + '/' + v.region_slug + '/' + v.district_slug + '/' + v.slug + '/');
    }

    function renderResults(matches) {
      if (!matches.length) { searchResults.classList.remove('is-open'); return; }
      searchResults.innerHTML = matches.slice(0, 8).map(function(v, i) {
        return '<a class="search-item' + (i === activeIdx ? ' is-active' : '') + '" href="' + getLink(v) + '" target="_blank" rel="noopener noreferrer" role="option">' +
          '<div class="search-item__thumb"><img src="' + v.thumbnail + '" alt="' + v.name + '" width="40" height="40"></div>' +
          '<div class="search-item__info"><div class="search-item__name">' + v.name + '</div>' +
          '<div class="search-item__meta">' + v.region + ' ' + v.district + ' · ' + v.category + '</div></div>' +
          '<span class="search-item__cta">상세보기 →</span></a>';
      }).join('');
      searchResults.classList.add('is-open');
    }

    if (searchInput) {
      searchInput.addEventListener('input', function() {
        var q = searchInput.value.trim();
        if (!q) { searchResults.classList.remove('is-open'); return; }
        activeIdx = -1;
        renderResults(searchVenues(q));
      });

      searchInput.addEventListener('keydown', function(e) {
        var items = searchResults.querySelectorAll('.search-item');
        if (!items.length) return;
        if (e.key === 'ArrowDown') { e.preventDefault(); activeIdx = Math.min(activeIdx + 1, items.length - 1); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); activeIdx = Math.max(activeIdx - 1, 0); }
        else if (e.key === 'Enter' && activeIdx >= 0) { e.preventDefault(); items[activeIdx].click(); }
        else if (e.key === 'Escape') { searchResults.classList.remove('is-open'); return; }
        items.forEach(function(el, i) { el.classList.toggle('is-active', i === activeIdx); });
      });
    }

    document.addEventListener('click', function(e) {
      if (!e.target.closest('.search-box')) searchResults.classList.remove('is-open');
    });

    // Quick Filters
    var cards = document.querySelectorAll('.venue-card');
    var noResults = document.getElementById('no-results');
    var regionFilter = 'all', catFilter = 'all';

    function applyFilters() {
      var visible = 0;
      cards.forEach(function(card) {
        var r = card.querySelector('.venue-card__region') ? card.querySelector('.venue-card__region').textContent : '';
        var c = card.querySelector('.venue-card__type') ? card.querySelector('.venue-card__type').textContent : '';
        var show = (regionFilter === 'all' || r === regionFilter) && (catFilter === 'all' || c === catFilter);
        card.style.display = show ? '' : 'none';
        if (show) visible++;
      });
      if (noResults) noResults.style.display = visible ? 'none' : '';
    }

    document.querySelectorAll('.filter-bar').forEach(function(bar) {
      bar.addEventListener('click', function(e) {
        var pill = e.target.closest('.filter-pill');
        if (!pill) return;
        var filterType = bar.dataset.filter;
        bar.querySelectorAll('.filter-pill').forEach(function(p) { p.classList.remove('active'); });
        pill.classList.add('active');
        if (filterType === 'region') regionFilter = pill.dataset.value || 'all';
        else catFilter = pill.dataset.value || 'all';
        applyFilters();
      });
    });
  </script>
</BaseLayout>
